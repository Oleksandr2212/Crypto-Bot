import os
import json
import asyncio
import logging
import feedparser
import requests
from aiogram import Bot, Dispatcher, types, F
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

TOKEN = os.getenv("TELEGRAM_TOKEN")
if not TOKEN:
    TOKEN = "8061893484:AAGghaHpuDqjCIiMa9llAJkBC84eRruO0S0"  # –∑–∞–ø–∞—Å–Ω–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç

bot = Bot(token=TOKEN)
dp = Dispatcher()

# –°–ª–æ–≤–Ω–∏–∫ –±—ñ—Ä–∂ –¥–ª—è –∞—Ä–±—ñ—Ç—Ä–∞–∂—É
EXCHANGES = {
    "Binance": "https://api.binance.com/api/v3/ticker/price?symbol={coin}USDT",
    "Kraken": "https://api.kraken.com/0/public/Ticker?pair={coin}USDT",
    "Kucoin": "https://api.kucoin.com/api/v1/market/orderbook/level1?symbol={coin}-USDT",
}

# –ú–µ–Ω—é
main_menu = ReplyKeyboardMarkup(
    keyboard=[
        [KeyboardButton("üíπ –ö—É—Ä—Å–∏"), KeyboardButton("ü§ù P2P –ø—Ä–æ–¥–∞–≤—Ü—ñ")],
        [KeyboardButton("üì∞ –ù–æ–≤–∏–Ω–∏"), KeyboardButton("‚è∞ –ù–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è")],
        [KeyboardButton("üí± –ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä"), KeyboardButton("üìä –ê–Ω–∞–ª—ñ—Ç–∏–∫–∞")],
        [KeyboardButton("üíµ –†–∞–¥–Ω–∏–∫"), KeyboardButton("‚úÖ Accept Terms")],
        [KeyboardButton("‚ÑπÔ∏è –î–æ–ø–æ–º–æ–≥–∞")]
    ],
    resize_keyboard=True
)

# –¢—Ä–µ–∫ –¥–ª—è —é–∑–µ—Ä—ñ–≤, —è–∫—ñ –ø—Ä–∏–π–Ω—è–ª–∏ —É–º–æ–≤–∏
accepted_terms = set()

# ===== –î–æ–ø–æ–º—ñ–∂–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó =====
def fetch_price(exchange: str, url: str, coin: str):
    try:
        if exchange == "Binance":
            r = requests.get(url.format(coin=coin)).json()
            return float(r["price"])
        elif exchange == "Kraken":
            sym = f"{coin}USDT"
            r = requests.get(url.format(coin=coin)).json()
            result = r["result"]
            first_key = list(result.keys())[0]
            return float(result[first_key]["c"][0])
        elif exchange == "Kucoin":
            r = requests.get(url.format(coin=coin)).json()
            return float(r["data"]["price"])
    except Exception as e:
        logger.warning(f"{exchange} fetch error: {e}")
    return None

def load_p2p():
    try:
        with open("p2p.json", "r", encoding="utf-8") as f:
            return json.load(f)
    except:
        return []

def get_news():
    feeds = [
        "https://finance.yahoo.com/rss/topstories",
        "https://www.coindesk.com/arc/outboundfeeds/rss/",
        "https://cryptopotato.com/feed/"
    ]
    articles = []
    for f in feeds:
        try:
            d = feedparser.parse(f)
            for e in d.entries[:3]:
                articles.append(f"üîó {e.title}\n{e.link}")
        except:
            continue
    return articles if articles else ["‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –Ω–æ–≤–∏–Ω–∏."]

# ===== –•–µ–Ω–¥–ª–µ—Ä–∏ =====
@dp.message(F.text == "/start")
async def start_handler(message: types.Message):
    await message.answer(
        "üëã –í—ñ—Ç–∞—î–º–æ —É Crypto Helper!\n"
        "–ü–µ—Ä–µ–¥ –ø–æ—á–∞—Ç–∫–æ–º –ø–æ—Ç—Ä—ñ–±–Ω–æ –ø—Ä–∏–π–Ω—è—Ç–∏ —É–º–æ–≤–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è.\n"
        "–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å ‚úÖ Accept Terms —â–æ–± –ø—Ä–æ–¥–æ–≤–∂–∏—Ç–∏.",
        reply_markup=main_menu
    )

@dp.message(F.text == "‚úÖ Accept Terms")
async def terms_handler(message: types.Message):
    accepted_terms.add(message.from_user.id)
    disclaimer = (
        "‚úÖ –í–∏ –ø—Ä–∏–π–Ω—è–ª–∏ —É–º–æ–≤–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è.\n\n"
        "‚ö†Ô∏è Disclaimer:\n"
        "–£—Å—ñ –¥—ñ—ó –∑ P2P –ø—Ä–æ–¥–∞–≤—Ü—è–º–∏ –≤—ñ–¥–±—É–≤–∞—é—Ç—å—Å—è –Ω–∞ –≤–∞—à –≤–ª–∞—Å–Ω–∏–π —Ä–∏–∑–∏–∫ —ñ –∑–≥—ñ–¥–Ω–æ –∑ –∑–∞–∫–æ–Ω–æ–¥–∞–≤—Å—Ç–≤–æ–º –£–∫—Ä–∞—ó–Ω–∏.\n"
        "–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ü—ñ—è –±–æ—Ç–∞ –Ω–µ –Ω–µ—Å–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω–æ—Å—Ç—ñ –∑–∞ –º–æ–∂–ª–∏–≤—ñ —Ñ—ñ–Ω–∞–Ω—Å–æ–≤—ñ –≤—Ç—Ä–∞—Ç–∏ —á–∏ —à–∞—Ö—Ä–∞–π—Å—å–∫—ñ –¥—ñ—ó.\n"
        "–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ —Ü–µ–π –±–æ—Ç, –≤–∏ –ø–æ–≥–æ–¥–∂—É—î—Ç–µ—Å—å —ñ–∑ —Ü–∏–º–∏ —É–º–æ–≤–∞–º–∏."
    )
    await message.answer(disclaimer)

@dp.message(F.text == "üíπ –ö—É—Ä—Å–∏")
async def rates_handler(message: types.Message):
    coins = ["BTC", "ETH", "SOL"]
    text = "üìä –ö—É—Ä—Å–∏ –∑–∞—Ä–∞–∑:\n"
    for c in coins:
        price = fetch_price("Binance", EXCHANGES["Binance"], c)
        if price:
            text += f"{c}: {price:.2f} USDT\n"
    await message.answer(text)

@dp.message(F.text == "ü§ù P2P –ø—Ä–æ–¥–∞–≤—Ü—ñ")
async def p2p_handler(message: types.Message):
    sellers = load_p2p()
    if not sellers:
        await message.answer("‚ùå –°–ø–∏—Å–æ–∫ –ø—Ä–æ–¥–∞–≤—Ü—ñ–≤ –ø–æ—Ä–æ–∂–Ω—ñ–π.")
        return
    lines = [f"{s['name']} ‚Äî {s['rate']} {s['currency']}, –ª—ñ–º—ñ—Ç: {s['limit']}, –∫–æ–Ω—Ç–∞–∫—Ç: {s['contact']}" for s in sellers]
    await message.answer("\n".join(lines))

@dp.message(F.text == "üì∞ –ù–æ–≤–∏–Ω–∏")
async def news_handler(message: types.Message):
    articles = get_news()
    await message.answer("\n\n".join(articles[:5]))

@dp.message(F.text == "üíµ –†–∞–¥–Ω–∏–∫")
async def advisor_handler(message: types.Message):
    coins = ["BTC", "ETH", "SOL", "USDT"]
    results = []
    for coin in coins:
        prices = {}
        for name, url in EXCHANGES.items():
            p = fetch_price(name, url, coin)
            if p:
                prices[name] = p
        if len(prices) >= 2:
            min_ex = min(prices, key=prices.get)
            max_ex = max(prices, key=prices.get)
            diff = prices[max_ex] - prices[min_ex]
            if diff > 1:
                results.append(
                    f"üí° {coin}: –ö—É–ø–∏ –Ω–∞ {min_ex} ({prices[min_ex]:.2f}) ‚Üí "
                    f"–ü—Ä–æ–¥–∞–π –Ω–∞ {max_ex} ({prices[max_ex]:.2f}) | "
                    f"–ü—Ä–∏–±—É—Ç–æ–∫: {diff:.2f} USDT"
                )
            else:
                results.append(f"{coin}: —Ä—ñ–∑–Ω–∏—Ü—è –Ω–µ–∑–Ω–∞—á–Ω–∞.")
        else:
            results.append(f"‚ö†Ô∏è –î–∞–Ω—ñ –¥–ª—è {coin} –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ñ.")
    await message.answer("\n\n".join(results))

@dp.message(F.text == "‚ÑπÔ∏è –î–æ–ø–æ–º–æ–≥–∞")
async def help_handler(message: types.Message):
    await message.answer(
        "‚ÑπÔ∏è –î–æ–≤—ñ–¥–∫–∞:\n\n"
        "üíπ –ö—É—Ä—Å–∏ ‚Äì –ø–æ–∫–∞–∑—É—î –∞–∫—Ç—É–∞–ª—å–Ω—ñ —Ü—ñ–Ω–∏ –Ω–∞ –º–æ–Ω–µ—Ç–∏.\n"
        "ü§ù P2P –ø—Ä–æ–¥–∞–≤—Ü—ñ ‚Äì —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–¥–∞–≤—Ü—ñ–≤ USDT —Ç–∞ —ó—Ö–Ω—ñ –∫–æ–Ω—Ç–∞–∫—Ç–∏.\n"
        "üì∞ –ù–æ–≤–∏–Ω–∏ ‚Äì –æ—Å—Ç–∞–Ω–Ω—ñ –Ω–æ–≤–∏–Ω–∏ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç.\n"
        "‚è∞ –ù–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è ‚Äì –≤—Å—Ç–∞–Ω–æ–≤–ª—é–π—Ç–µ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –ø—Ä–æ —Ü—ñ–Ω–∏.\n"
        "üí± –ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä ‚Äì –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—è –≤–∞–ª—é—Ç.\n"
        "üìä –ê–Ω–∞–ª—ñ—Ç–∏–∫–∞ ‚Äì —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∏–Ω–∫—É.\n"
        "üíµ –†–∞–¥–Ω–∏–∫ ‚Äì –ø—ñ–¥–∫–∞–∑–∫–∏ –ø–æ –∞—Ä–±—ñ—Ç—Ä–∞–∂—É –º—ñ–∂ –±—ñ—Ä–∂–∞–º–∏.\n"
        "‚úÖ Accept Terms ‚Äì –ø–æ–≥–æ–¥–∂–µ–Ω–Ω—è –∑ –ø—Ä–∞–≤–∏–ª–∞–º–∏.\n"
    )

# ===== –ó–∞–ø—É—Å–∫ =====
async def main():
    logger.info("Bot started")
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())

